# Laravel RoadRunner Cache

[![Latest Version on Packagist](https://img.shields.io/packagist/v/asanikovich/laravel-roadrunner-cache.svg?style=flat-square)](https://packagist.org/packages/asanikovich/laravel-roadrunner-cache)
[![GitHub Tests Status](https://img.shields.io/github/actions/workflow/status/asanikovich/laravel-roadrunner-cache/tests.yml?branch=master&label=tests&style=flat-square)](https://github.com/asanikovich/laravel-roadrunner-cache/actions/workflows/tests.yml?query=branch%3Amaster)
[![GitHub Tests Coverage Status](https://img.shields.io/codecov/c/github/asanikovich/laravel-roadrunner-cache?token=GXMKS36D91&style=flat-square)](https://github.com/asanikovich/laravel-roadrunner-cache/actions/workflows/tests.yml?query=branch%3Amaster)
[![GitHub Code Style Status](https://img.shields.io/github/actions/workflow/status/asanikovich/laravel-roadrunner-cache/phpstan.yml?branch=master&label=code%20style&style=flat-square)](https://github.com/asanikovich/laravel-roadrunner-cache/actions/workflows/phpstan.yml?query=branch%3Amaster)
[![GitHub Lint Status](https://img.shields.io/github/actions/workflow/status/asanikovich/laravel-roadrunner-cache/pint.yml?branch=master&label=lint&style=flat-square)](https://github.com/asanikovich/laravel-roadrunner-cache/actions/workflows/pint.yml?query=branch%3Amaster)
[![Total Downloads](https://img.shields.io/packagist/dt/asanikovich/laravel-roadrunner-cache.svg?style=flat-square)](https://packagist.org/packages/asanikovich/laravel-roadrunner-cache)
[![Licence](https://img.shields.io/packagist/l/asanikovich/laravel-roadrunner-cache.svg?style=flat-square)](https://packagist.org/packages/asanikovich/laravel-roadrunner-cache)

**This Laravel package allows you to work with RoadRunner KV Cache in Laravel (as cache driver).**

## Getting Started

### Installing the Package

You can install the package via composer:

```bash
composer require asanikovich/laravel-roadrunner-cache
```

### Configuration

#### Configuration RoadRunner

Make sure you have in your RoadRunner config file (`.rr.yaml`) next sections:
- `RPC` section 
- `KV` section

Full example of RoadRunner configuration file:
```yaml
version: '3'
rpc:
  listen: 'tcp://127.0.0.1:6001'
server:
  command: php /var/www/html/vendor/bin/roadrunner-worker
http:
  address: '127.0.0.1:8080'
  pool:
    num_workers: 1
kv:
    memory:
        driver: memory
        config:
            interval: 1
    boltdb:
        driver: boltdb
        config:
            interval: 1
```

#### Publish config
Publish the config file and setup RPC connection:

```bash
php artisan vendor:publish --tag="laravel-roadrunner-cache-config"
```

#### Serializers

Package supports next serializers (should be configured in `store` config):
- `null` - default php `serializer`
- `igbinary` - igbinary serializer, `ext-igbinary` is required to be installed

#### Encryption

Package supports encryption with `sodium`, requirements:
- `ext-sodium` required to be installed 
- `encryption_key` filled  in `store` config (generated by `sodium_crypto_box_keypair()`)

#### Setup cache config file 

Add to cache configuration file (`/config/cache.php`) new store with driver `roadrunner`: 

#### Config file example
```php
<?php
return [
    'default' => 'rr-memory', // Default store (optional)

    'stores' => [
        'rr-memory' => [ // Custom store name with "memory" connection 
            'driver' => 'roadrunner',
            'connection' => 'memory', // section name from KV plugin settings in RoadRunner config file (.rr.yaml)
            'serializer' => null, // Available options: null|igbinary
            'encryption_key' => null, // Available options: null|string
        ],
        'rr-boltdb' => [ // Custom store name with "boltdb" connection (another store is optional)
            'driver' => 'roadrunner',
            'connection' => 'boltdb', // section name from KV plugin settings in RoadRunner config file (.rr.yaml)
            'serializer' => null, // Available options: null|igbinary
            'encryption_key' => null, // Available options: null|string
            'prefix' => 'custom', // Custom prefix - non-empty-string
        ],
        'rr-memory-igbinary' => [ // Custom store name with "memory" connection and "igbinary" serializer
            'driver' => 'roadrunner',
            'connection' => 'memory', // section name from KV plugin settings in RoadRunner config file (.rr.yaml)
            'serializer' => 'igbinary', // Available options: null|igbinary
            'encryption_key' => null, // Available options: null|string
        ],
        'rr-memory-igbinary-encrypted' => [ // Custom store name with "memory" connection and encrypted "igbinary" serializer
            'driver' => 'roadrunner',
            'connection' => 'memory', // section name from KV plugin settings in RoadRunner config file (.rr.yaml)
            'serializer' => 'igbinary', // Available options: null|igbinary
            'encryption_key' => 'key1', // Available options: null|string
        ],
         'rr-memory-encrypted' => [ // Custom store name with "memory" connection and encrypted serializer
            'driver' => 'roadrunner',
            'connection' => 'memory', // section name from KV plugin settings in RoadRunner config file (.rr.yaml)
            'serializer' => null, // Available options: null|igbinary
            'encryption_key' => 'key2', // Available options: null|string
        ],
    ],
]
```

### Usage

To use in your code:
```php
<?php
    use Illuminate\Support\Facades\Cache;

    Cache::driver()->get('key'); // Default main store - rr-memory
    Cache::driver('rr-boltdb')->get('key'); // rr-boltdb store
```

All done! ðŸš€

## Development
Here are some useful commands for development

Before running tests run docker-compose:
```bash
docker-compose up -d
```
Run tests:
```bash
composer run test
```
Run tests with coverage:
```bash
composer run test-coverage
```
Perform type checking:
```bash
composer run phpstan
```
Format your code:
```bash
composer run format
```

## Updates and Changes

For details on updates and changes, please refer to our [CHANGELOG](CHANGELOG.md).

## License

Laravel RoadRunner Cache is released under The MIT License (MIT). For more information, please see our [License File](LICENSE.md).
